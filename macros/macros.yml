version: 2

macros:
  - name: apply_table_and_column_comments
    description: Applies table and column comments from YAML schema to Snowflake objects. Designed for use in post-hooks to automatically document tables after creation.
    arguments:
      - name: model
        type: relation
        description: The dbt model relation object (usually 'this' in post-hooks)

  - name: generate_schema_name
    description: Overrides dbt's default schema naming behavior. Uses custom schema name directly instead of concatenating with target schema.
    arguments:
      - name: custom_schema_name
        type: string
        description: The custom schema name from model config
      - name: node
        type: object
        description: The dbt node object (automatically passed by dbt)

  - name: merge_stage_into_table
    description: Merges data from external stage into target table with metadata tracking. Updates existing files if modified timestamp changed, inserts new files.
    arguments:
      - name: target_table
        type: string
        description: Destination table name
      - name: stage_path
        type: string
        description: Snowflake external stage path
      - name: file_format
        type: string
        description: File format name for parsing
      - name: system_id
        type: string
        description: Source system identifier (default 'FOURKITES')
      - name: stage_id
        type: string
        description: Processing stage identifier (default 'ACTIVE')
      - name: truncate_before_merge
        type: boolean
        description: Clear table before merge operation (default false)

  - name: normalize_stop_reference_id
    description: Normalizes stop reference IDs by removing leading zeros from numeric prefix. Processes IDs in format "NUMBER_SUFFIX".
    arguments:
      - name: s
        type: string
        description: The stop reference ID to normalize

  - name: strip_leading_zeros_if_numeric
    description: Strips leading zeros from strings that contain only digits. Non-numeric strings and null values are returned unchanged.
    arguments:
      - name: value
        type: string
        description: The input value to process (column reference, SQL expression, or literal string)

  - name: is_note_like
    description: |
      Determines whether a text value represents a note-like text fragment.
      Implements the Python is_note_like logic:
      - Empty or null → FALSE
      - Contains ":" → FALSE
      - Only digits → FALSE
      - Contains keywords such as 'add ', 'required', 'precall', 'charge', etc. → TRUE
    arguments:
      - name: value
        type: string
        description: Column or expression to evaluate

  - name: is_party_like
    description: |
      Determines whether a text value looks like a party/organization/person name.
      Implements the Python is_party_like logic:
      - Empty or null → FALSE
      - Contains ":" → FALSE
      - Phone-like strings → TRUE
      - Only digits → FALSE
      - Matches alphabetic name-style pattern → TRUE
    arguments:
      - name: value
        type: string
        description: Column or expression to evaluate

  - name: is_phone_like
    description: |
      Detects phone-number-like text using a flexible regular expression supporting:
      - Optional country code
      - Optional parentheses around area code
      - Separators such as space, dash, or dot  
      Returns TRUE if the input matches a phone pattern; otherwise FALSE.
    arguments:
      - name: value
        type: string
        description: Column or expression to evaluate

  - name: num_or_none
    description: |
      Converts a value to a numeric type when possible.
      Implements the Python num_or_none logic:
      - NULL → NULL
      - Trims the string and checks NUM_DEC pattern: ^[+-]?\d+(\.\d+)?$
      - If matched → returns TRY_TO_DOUBLE(value)
      - Otherwise returns NULL
    arguments:
      - name: value
        type: string
        description: Column or expression to convert to numeric

  - name: parse_identifier_prefix
    description: |
      Extracts an identifier prefix (e.g., PO, SO, CN, VT, SI, etc.) from the beginning of a text value.
      Matches patterns like 'PO:12345' and returns only the prefix.
      Returns NULL when no valid prefix is present.
    arguments:
      - name: raw_text
        type: string
        description: Column or expression containing the raw reference string

  - name: parse_identifier_value
    description: |
      Extracts the value portion of an identifier in the format PREFIX:VALUE.
      Example: 'PO:12345' → '12345'.
      Returns NULL when no value portion is present.
    arguments:
      - name: raw_text
        type: string
        description: Column or expression containing the raw reference string
