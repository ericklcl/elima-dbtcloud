version: 2

models:
  - name: R_SHIPMENTS
    description: >
      Raw-normalized FourKites shipments table, ingested incrementally from JSON payloads. 
      Includes business fields, metadata, and row-level hashing for deduplication.
    
    columns:
      - name: SHIPMENT_ID
        description: >
          Unique shipment identifier from the FourKites payload.
      - name: LOAD_NUMBER
        description: >
          Load number with leading zeros stripped if numeric.
      - name: STATUS
        description: > 
          Shipment status according to FourKites.
      - name: SCAC
        description: >
          Standard Carrier Alpha Code identifying the carrier.
      - name: TOTAL_DISTANCE_M
        description: >
          Total shipment distance in meters.
      - name: REMAINING_DISTANCE_M
        description: >
          Remaining shipment distance in meters.
      - name: FOURKITES_ETA_TZ
        description: >
          Estimated Time of Arrival with time zone information.
      - name: TIME_ZONE
        description: >
          Time zone used for ETA.
      - name: NUM_DELIVERY_STOPS
        description: >
          The number of delivery stops for the shipment.
      - name: DELETED
        description: >
          Indicates whether the shipment has been flagged as deleted.
      - name: DELETED_BY
        description: >
          User or system that deleted the shipment.
      - name: DELETED_AT_TZ
        description: >
          Timestamp when the shipment was deleted (if applicable).
      
      # Metadata columns
      - name: _SYSTEM_ID
        description: >
          Source system identifier assigned during data ingestion.
      - name: _STAGE_ID
        description: >
          Logical ingestion stage that produced the record
          (e.g., ACTIVE, HIST, DLQ).
      - name: _META_FILENAME
        description: >
          Name of the staged file from which the record was ingested.
      - name: _META_ROW_NUMBER
        description: >
          Sequential row number representing the record’s position
          inside the original staged file.
      - name: _META_FILE_LAST_MODIFIED
        description: >
          Timestamp indicating when the source file was last modified
          in external storage.
      - name: _META_INGESTION_TIMESTAMP
        description: >
          Timestamp indicating when the record was ingested into Snowflake.
      - name: _META_ROW_HASH
        description: >
          MD5 hash of the raw JSON record, used for tracking changes
          and ensuring deterministic incremental loading.

  - name: R_SHIPMENT_STAKEHOLDERS
    description: >
      Extracts and flattens stakeholder information from the FourKites raw
      payload. Each record represents a stakeholder associated with a
      shipment, expanding the nested `stakeholders` JSON structure into
      a relational format. One row is produced for each combination of
      SHIPMENT_ID and PARTY_ROLE, along with ingestion metadata and a
      row-level hash for traceability.

    columns:
      - name: SHIPMENT_ID
        description: >
          Shipment identifier as provided by the FourKites payload.
      - name: PARTY_ROLE
        description: >
          The stakeholder role within the shipment context
          (e.g., SHIPPER, CONSIGNEE, CARRIER).
      - name: PARTY_NAME
        description: >
          The name of the stakeholder associated with the given PARTY_ROLE.

      # Metadata columns
      - name: _SYSTEM_ID
        description: >
          Source system identifier assigned during data ingestion.
      - name: _STAGE_ID
        description: >
          Logical ingestion stage that produced the record
          (e.g., ACTIVE, HIST, DLQ).
      - name: _META_FILENAME
        description: >
          Name of the staged file from which the record was ingested.
      - name: _META_ROW_NUMBER
        description: >
          Sequential row number representing the record’s position
          inside the original staged file.
      - name: _META_FILE_LAST_MODIFIED
        description: >
          Timestamp indicating when the source file was last modified
          in external storage.
      - name: _META_INGESTION_TIMESTAMP
        description: >
          Timestamp indicating when the record was ingested into Snowflake.
      - name: _META_ROW_HASH
        description: >
          MD5 hash of the raw JSON record, used for tracking changes
          and ensuring deterministic incremental loading.

  - name: R_SHIPMENT_DELIVERY_NUMBERS
    description: >
      Extracts and normalizes purchase order numbers from FourKites shipments.
      Each row represents a delivery number associated with a shipment, flattening
      the nested purchase order numbers array into individual records with sequence
      information and normalized delivery numbers.
    
    columns:
      - name: SHIPMENT_ID
        description: >
          Unique shipment identifier from the FourKites payload.
      - name: DELIVERY_SEQ
        description: >
          Sequential number indicating the order of the delivery number 
          within the purchase order numbers array (1-based index).
      - name: DELIVERY_NUMBER
        description: >
          Individual delivery/purchase order number with leading zeros 
          stripped if the value is purely numeric.
      - name: PURCHASE_ORDER_NUMBERS
        description: >
          Complete purchase order numbers array from the original payload 
          for reference and auditing purposes.

      # Metadata columns
      - name: _SYSTEM_ID
        description: >
          Source system identifier assigned during data ingestion.
      - name: _STAGE_ID
        description: >
          Logical ingestion stage that produced the record
          (e.g., ACTIVE, HIST, DLQ).
      - name: _META_FILENAME
        description: >
          Name of the staged file from which the record was ingested.
      - name: _META_ROW_NUMBER
        description: >
          Sequential row number representing the record's position
          inside the original staged file.
      - name: _META_FILE_LAST_MODIFIED
        description: >
          Timestamp indicating when the source file was last modified
          in external storage.
      - name: _META_INGESTION_TIMESTAMP
        description: >
          Timestamp indicating when the record was ingested into Snowflake.
      - name: _META_ROW_HASH
        description: >
          MD5 hash of the raw JSON record, used for tracking changes
          and ensuring deterministic incremental loading.

  - name: R_PALLET_PARTS
    description: "Parsed pallet parts extracted from the FourKites JSON payload."

    columns:
      - name: STOP_ID
        description: "Unique ID of the stop (FourKites stop ID)."

      - name: PALLET_SEQ
        description: "Sequential pallet index per STOP_ID and file."

      - name: PART_SEQ
        description: "Sequential part index inside the pallet."

      - name: DESCRIPTION
        description: "Part description extracted from the pallet structure."

      - name: SHIPPER_PART_NUMBER
        description: "Shipper or customer part number."

      - name: QUANTITY_RAW
        description: "Raw quantity string received from FourKites."

      - name: QUANTITY_NUM
        description: "Numeric representation of the quantity."

      - name: WEIGHT_RAW
        description: "Raw weight string received from FourKites."

      - name: WEIGHT_NUM
        description: "Numeric representation of the weight."

      # METADATA FIELDS
      - name: _SYSTEM_ID
        description: "System identifier for the ingestion source."

      - name: _STAGE_ID
        description: "Ingestion stage identifier."

      - name: _META_FILENAME
        description: "Original filename from which data was ingested."

      - name: _META_ROW_NUMBER
        description: "Row number inside the ingested file."

      - name: _META_FILE_LAST_MODIFIED
        description: "Timestamp of last modification of the ingested file."

      - name: _META_INGESTION_TIMESTAMP
        description: "Timestamp when the file was ingested."

      - name: _META_ROW_HASH
        description: "MD5 hash of the full JSON record for deduplication."

  - name: R_STOPS
    description: "Flattened stop-level data extracted from the FourKites JSON payload."

    columns:
      - name: STOP_ID
        description: "FourKites stop identifier (fourKitesStopID)."

      - name: SHIPMENT_ID
        description: "Unique FourKites shipment ID."

      - name: STOP_OBJ
        description: "Full JSON object representing the stop."

      - name: STOP_TYPE
        description: "Type of stop (Pickup, Delivery, etc.)."

      - name: STATUS
        description: "Stop status."

      - name: STOP_NAME
        description: "Human-readable stop name."

      - name: CITY
        description: "City where the stop occurred."

      - name: STATE
        description: "State or province for the stop."

      - name: COUNTRY
        description: "Country code for the stop."

      - name: EXTERNAL_ADDRESS_ID
        description: "External customer or address identifier."

      - name: LATITUDE
        description: "Latitude of the stop location."

      - name: LONGITUDE
        description: "Longitude of the stop location."

      - name: TIME_ZONE
        description: "Time zone of the stop location."

      - name: SEQUENCE_NUM
        description: "Sequence number of the stop."

      - name: ARRIVAL_TIME_TZ
        description: "Arrival timestamp with timezone."

      - name: DEPARTURE_TIME_TZ
        description: "Departure timestamp with timezone."

      - name: POSTAL_CODE
        description: "Postal or ZIP code of the stop."

      - name: DELETED
        description: "Indicates if the stop was marked as deleted."

      - name: DELETED_BY
        description: "User who deleted the stop, if applicable."

      - name: DELETED_AT_TZ
        description: "Timestamp when the stop was deleted."

      # METADATA FIELDS
      - name: _SYSTEM_ID
        description: "Ingestion system identifier."

      - name: _STAGE_ID
        description: "Ingestion stage identifier."

      - name: _META_FILENAME
        description: "Original filename from which the JSON was ingested."

      - name: _META_ROW_NUMBER
        description: "Row number inside the ingested file."

      - name: _META_FILE_LAST_MODIFIED
        description: "Last modification timestamp of the file."

      - name: _META_INGESTION_TIMESTAMP
        description: "Timestamp when the ingestion occurred."

      - name: _META_ROW_HASH
        description: "Hash of the original JSON row."    

  - name: R_STOP_PALLETS
    description: "Flattened pallet-level data extracted from the FourKites stop objects."

    columns:
      - name: STOP_ID
        description: "Identifier of the stop to which the pallet belongs."

      - name: PALLET_SEQ
        description: "Sequential pallet index per STOP_ID and file."

      - name: PALLET_OBJ
        description: "Full JSON object representing the pallet."

      # METADATA FIELDS
      - name: _SYSTEM_ID
        description: "Ingestion system identifier."

      - name: _STAGE_ID
        description: "Ingestion stage identifier."

      - name: _META_FILENAME
        description: "Source filename from which the data was extracted."

      - name: _META_ROW_NUMBER
        description: "Row number inside the ingested file."

      - name: _META_FILE_LAST_MODIFIED
        description: "Timestamp for when the file was last modified."

      - name: _META_INGESTION_TIMESTAMP
        description: "Timestamp for when ingestion occurred."

      - name: _META_ROW_HASH
        description: "MD5 hash of the JSON record for deduplication."

  - name: R_STOP_CUSTOMERS
    description: "Stop-level customer mapping extracted from the FourKites JSON payload."

    columns:
      - name: STOP_ID
        description: "FourKites stop identifier (fourKitesStopID)."

      - name: CUSTOMER_ID
        description: "Customer ID inside the stop object (customer.ID)."

      # METADATA FIELDS
      - name: _SYSTEM_ID
        description: "Ingestion system identifier."

      - name: _STAGE_ID
        description: "Ingestion stage identifier."

      - name: _META_FILENAME
        description: "Source filename from which the JSON was ingested."

      - name: _META_ROW_NUMBER
        description: "Row number inside the ingested file."

      - name: _META_FILE_LAST_MODIFIED
        description: "Timestamp indicating when the file was last modified."

      - name: _META_INGESTION_TIMESTAMP
        description: "Timestamp indicating when the file was ingested."

      - name: _META_ROW_HASH
        description: "MD5 hash of the full JSON record for deduplication."

  - name: R_STOP_SCHEDULES
    description: "Stop-level scheduling information extracted from the FourKites JSON payload."

    columns:
      - name: VALUE
        description: "Full stop JSON object (raw stop struct)."

      - name: STOP_ID
        description: "FourKites stop identifier (fourKitesStopID)."

      - name: APPOINTMENT_TIME_TZ
        description: "Scheduled appointment time with timezone."

      - name: APPOINTMENT_WINDOW_START_TZ
        description: "Start of the appointment window with timezone."

      - name: APPOINTMENT_WINDOW_END_TZ
        description: "End of the appointment window with timezone."

      - name: WANT_TIME_TZ
        description: "Customer requested time (wantTime) with timezone."

      # METADATA FIELDS
      - name: _SYSTEM_ID
        description: "Ingestion system identifier."

      - name: _STAGE_ID
        description: "Ingestion stage identifier."

      - name: _META_FILENAME
        description: "Name of the file from which the JSON was ingested."

      - name: _META_ROW_NUMBER
        description: "Row number in the source file."

      - name: _META_FILE_LAST_MODIFIED
        description: "Timestamp indicating last file modification."

      - name: _META_INGESTION_TIMESTAMP
        description: "Timestamp indicating when the record was ingested."

      - name: _META_ROW_HASH
        description: "MD5 hash of the full JSON record for deduplication."